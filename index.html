<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stock Watchlist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .canvas-container {
            width: 100%;
            height: 75vh;
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center justify-center">
                <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                Live Stock Watchlist
            </h1>
        </header>

        <div class="mb-4 flex flex-col sm:flex-row gap-4">
            <input type="text" id="searchInput" placeholder="Search by stock symbol or name..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            <button id="updateButton" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                <svg id="updateIcon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4l-5 5M4 20l5-5"></path></svg>
                <span id="updateText">Update Prices</span>
            </button>
        </div>

        <div id="message-container" class="text-center p-4 my-4 rounded-lg hidden"></div>

        <div class="canvas-container">
            <canvas id="stockCanvas"></canvas>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- START CONFIGURATION ---

        // !!! IMPORTANT !!!
        // PASTE YOUR FREE API KEY FROM ALPHA VANTAGE HERE
        const apiKey = "AETMK5XOVYUZNIDX";

        // You can use the short list for testing or the full list for production
        const stockSymbols = [
            'AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'NVDA', 'META', 'SBUX', 'NKE', 'DIS'
        ];

        const fullStockList = [
            'ABEO','ABVX','ACAD','ACB','ACHR','ACLX','ADAP','ADV','AGAE','AGEN','AGL','AGNC','AI','AIFF','AKO.B','ALAB','AMC','AMLX','AMPL','AMRN','AMRX','ANTX','APPS','ARM','ARQQ','ARR','ARTL','ARVN','ASAN','ASST','ATAT','ATCH','ATHE','AUPH','AUR','AVIR','AVXL','AYRWF','BAND','BCAX','BCS','BCTCF','BDRX','BGMS','BHC','BIOA','BKYI','BLBX','BMBL','BNXAF','BNZI','BOF','BPMC','BRPHF','BRR','BRT','BRY','BUD','CAG','CAKE','CELH','CEP','CGC','CLBR','CLM','CLSK','CMG','CMPS','CMTL','CNBS','COEP','COUR','CPB','CPIX','CRBU','CRGY','CRON','CRSP','CRVS','CSTL','CTRN','CURLF','CXDO','CYTK','DARE','DDC','DFDV','DFLI','DFSC','DLMAF','DLTR','DNA','DRVN','DYN','EDRY','EFC','EHAB','EL','ELF','ENB','ENR','EOLS','EQT','ERNA','ESPR','ETNB','EXEL','EXXRF','EYPT','FA','FAT','FATBP','FIG','FIZZ','FMS','FOXX','FPI','FVRR','GALT','GB','GCT','GDRX','GETY','GLAD','GLCNF','GLNCY','GME','GNS','GRAL','HBI','HIMS','HLN','HOFV','HOLO','HOOD','HOTH','HRI','HTGC','HTZ','HUMA','HUT','HYPD','IDRSF','ILLR','IMTX','IMVT','INCY','INGM','INM','INMB','INVZ','IONQ','IRD','ITOS','IVVD','JD','JFIN','JOBY','JSAIY','JTAI','KAPA','KHC','KLG','KNSA','KOSS','KR','KROS','KURA','KVUE','KYMR','KYTX','KZIA','LAC','LAES','LAZR','LCID','LCUT','LEAT','LINE','LIPO','LITB','LKNCY','LMND','LQDA','LSF','LTH','MAC','MAIN','MARA','MB','MBRX','MDWD','MGX','MLGO','MNKD','MNST','MO','MSGE','MYNZ','MYSE','NAKA','NBIS','NERV','NEWT','NGENF','NIO','NKTR','NNE','NRXP','NTWK','NU','NVAX','NVO','NVST','NVTS','NWG','OGN','OKLO','OPHLY','OPY','ORC','ORMP','OUST','OVID','OXY','PASG','PBH','PFE','PGEN','PHAT','PHIO','PL','PLTR','PODD','POWW','PRDSF','PROF','PSEC','PSTV','PTON','QBTS','QMCO','QQQY','QSI','QUBT','RDY','REKR','RERE','RGNX','RGTI','RIOT','RITM','RIVN','RKLB','RKUNY','ROIV','ROKU','RPRX','RUM','RVPH','SAGE','SANA','SBEV','SBGI','SBH','SBUX','SCS','SEPN','SERV','SGMO','SHLS','SIRI','SJT','SKX','SLRX','SMCI','SMR','SOFI','SOLV','SOUN','SPHR','SRPT','STEC','STKL','STLA','SWVL','SYTA','TAK','TALK','TARS','TCEHY','TCNNF','TCOM','TCPC','TECK','TERN','TGT','TLRY','TMDX','TME','TNXP','TOON','TPICQ','TSCDF','TSCDY','TSCO','TYRA','U','UDMY','ULTA','UTHR','VALE','VCEL','VMAR','VRNA','VTRS','VVV','WB','WBA','WEED:CA','WEN','WFC','WGHTQ','WMB','WPP','WRD','XENE','XERS','XIFR','XRP-USD','XXII','XYZ','YI','YMM','YSG','ZIM','ZIP','ZRSEF','ZVRA','ZVSA','ZYME'
        ];
        
        const stockNameMap = {
            'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc.', 
            'AMZN': 'Amazon.com, Inc.', 'TSLA': 'Tesla, Inc.', 'NVDA': 'NVIDIA Corporation',
            'META': 'Meta Platforms, Inc.', 'SBUX': 'Starbucks Corporation', 'NKE': 'NIKE, Inc.', 'DIS': 'The Walt Disney Company'
        };

        // --- END CONFIGURATION ---

        const canvas = document.getElementById('stockCanvas');
        const ctx = canvas.getContext('2d');
        const searchInput = document.getElementById('searchInput');
        const updateButton = document.getElementById('updateButton');
        const messageContainer = document.getElementById('message-container');

        let stocks = [];
        let filteredStocks = [];
        let sortColumn = 'symbol';
        let sortDirection = 'asc';
        let scrollY = 0;
        let isDragging = false;
        let lastY = 0;

        const rowHeight = 40;
        const headerHeight = 50;

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            draw();
        }

        function showMessage(type, text) {
            messageContainer.className = `text-center p-4 my-4 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`;
            messageContainer.textContent = text;
            messageContainer.classList.remove('hidden');
        }

        function hideMessage() {
            messageContainer.classList.add('hidden');
        }
        
        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        async function fetchAllStocks() {
            if (apiKey === "AETMK5XOVYUZNIDX" || !apiKey) {
                showMessage('error', 'API Key is not set. Please edit index.html to add your Alpha Vantage API key.');
                return;
            }

            setButtonLoading(true);
            hideMessage();
            
            let fetchedStocks = [];
            const symbolsToFetch = stockSymbols; // Change to fullStockList to fetch all
            let apiCallCount = 0;
            const maxApiCalls = 25; // Safety limit per update

            for (const symbol of symbolsToFetch) {
                 if(apiCallCount >= maxApiCalls) {
                    console.warn(`API call limit (${maxApiCalls}) reached for this update cycle.`);
                    break;
                }
                try {
                    const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`;
                    const data = await fetchWithRetry(url);
                    apiCallCount++;

                    const quote = data['Global Quote'];
                    if (quote && quote['01. symbol']) {
                        fetchedStocks.push({
                            symbol: quote['01. symbol'],
                            name: stockNameMap[quote['01. symbol']] || `${quote['01. symbol']} Name`, // Add names later if needed
                            price: parseFloat(quote['05. price']),
                            change: parseFloat(quote['09. change']),
                            changePercent: quote['10. change percent'],
                        });
                    } else if (data.Note) {
                        console.warn(`API rate limit likely hit for ${symbol}. Pausing and will retry later.`);
                        await new Promise(res => setTimeout(res, 60000)); // Wait 1 minute
                    } else {
                        console.warn(`Could not get quote for ${symbol}. Response:`, data);
                    }
                } catch (error) {
                    console.error(`Error fetching ${symbol}:`, error);
                }
            }
            
            if (fetchedStocks.length > 0) {
                stocks = fetchedStocks;
                filterAndSort();
            } else {
                 showMessage('error', 'Failed to fetch any stock data. Check your API key or network connection.');
            }

            setButtonLoading(false);
        }
        
        function setButtonLoading(isLoading) {
            const button = document.getElementById('updateButton');
            const text = document.getElementById('updateText');
            const icon = document.getElementById('updateIcon');

            if (isLoading) {
                button.disabled = true;
                button.classList.add('cursor-not-allowed', 'bg-gray-400');
                text.textContent = 'Updating...';
                icon.innerHTML = `<path d="M12 6v6m0 0v6m0-6h6m-6 0H6" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" transform="rotate(45 12 12)"></path>`;
                icon.classList.add('animate-spin');
            } else {
                button.disabled = false;
                button.classList.remove('cursor-not-allowed', 'bg-gray-400');
                text.textContent = 'Update Prices';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4l-5 5M4 20l5-5"></path>`;
                icon.classList.remove('animate-spin');
            }
        }


        function filterAndSort() {
            const searchTerm = searchInput.value.toLowerCase();
            filteredStocks = stocks.filter(stock =>
                stock.symbol.toLowerCase().includes(searchTerm) ||
                stock.name.toLowerCase().includes(searchTerm)
            );

            filteredStocks.sort((a, b) => {
                const valA = a[sortColumn];
                const valB = b[sortColumn];
                let comparison = 0;
                if (valA > valB) {
                    comparison = 1;
                } else if (valA < valB) {
                    comparison = -1;
                }
                return sortDirection === 'asc' ? comparison : comparison * -1;
            });

            scrollY = 0; // Reset scroll on new filter/sort
            draw();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawHeader();
            drawRows();
        }

        function drawHeader() {
            const columns = [
                { name: 'Symbol', width: 0.2, key: 'symbol' },
                { name: 'Name', width: 0.3, key: 'name' },
                { name: 'Price', width: 0.15, key: 'price' },
                { name: 'Change', width: 0.15, key: 'change' },
                { name: '% Change', width: 0.2, key: 'changePercent' }
            ];

            ctx.fillStyle = '#374151'; // gray-700
            ctx.fillRect(0, 0, canvas.width, headerHeight);

            ctx.font = 'bold 14px Inter';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            let x = 0;
            columns.forEach(col => {
                const colWidth = canvas.width * col.width;
                let text = col.name;
                if (col.key === sortColumn) {
                    text += sortDirection === 'asc' ? ' ▲' : ' ▼';
                }
                ctx.fillText(text, x + colWidth / 2, headerHeight / 2);
                x += colWidth;
            });
        }

        function drawRows() {
            const startIndex = Math.floor(scrollY / rowHeight);
            const endIndex = Math.min(startIndex + Math.ceil(canvas.height / rowHeight) + 1, filteredStocks.length);

            for (let i = startIndex; i < endIndex; i++) {
                const stock = filteredStocks[i];
                const y = headerHeight + i * rowHeight - scrollY;

                ctx.fillStyle = i % 2 === 0 ? '#F9FAFB' : 'white'; // gray-50
                ctx.fillRect(0, y, canvas.width, rowHeight);
                
                // Draw cells
                const columns = [
                    { value: stock.symbol, width: 0.2, align: 'left', font: '500 14px Inter' },
                    { value: stock.name, width: 0.3, align: 'left', font: '14px Inter' },
                    { value: stock.price.toFixed(2), width: 0.15, align: 'center', font: '500 14px Inter' },
                    { value: stock.change.toFixed(2), width: 0.15, align: 'center', color: stock.change >= 0 ? '#10B981' : '#EF4444' }, // green-500, red-500
                    { value: stock.changePercent, width: 0.2, align: 'center', color: stock.change >= 0 ? '#10B981' : '#EF4444' }
                ];
                
                let x = 0;
                columns.forEach(col => {
                    const colWidth = canvas.width * col.width;
                    ctx.font = col.font || '14px Inter';
                    ctx.fillStyle = col.color || '#111827'; // gray-900
                    ctx.textAlign = col.align;
                    
                    let textX;
                    if (col.align === 'left') {
                        textX = x + 10;
                    } else if (col.align === 'center') {
                        textX = x + colWidth / 2;
                    } else { // right
                        textX = x + colWidth - 10;
                    }
                    
                    ctx.fillText(col.value, textX, y + rowHeight / 2);
                    x += colWidth;
                });
            }
        }
        
        // --- Event Listeners ---
        window.addEventListener('resize', resizeCanvas);
        searchInput.addEventListener('input', filterAndSort);
        updateButton.addEventListener('click', fetchAllStocks);

        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            scrollY += e.deltaY;
            const maxScroll = Math.max(0, filteredStocks.length * rowHeight - canvas.height + headerHeight);
            scrollY = Math.max(0, Math.min(scrollY, maxScroll));
            draw();
        });

        canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const x = e.clientX - rect.left;

            if (y <= headerHeight) {
                const columns = [ { width: 0.2, key: 'symbol' }, { width: 0.3, key: 'name' }, { width: 0.15, key: 'price' }, { width: 0.15, key: 'change' }, { width: 0.2, key: 'changePercent' }];
                let currentX = 0;
                for(const col of columns) {
                    currentX += col.width * canvas.width;
                    if(x < currentX) {
                        if (sortColumn === col.key) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = col.key;
                            sortDirection = 'asc';
                        }
                        filterAndSort();
                        break;
                    }
                }
            }
        });

        // Initial setup
        resizeCanvas();
        fetchAllStocks();
    });
    </script>
</body>
</html>

